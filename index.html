<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina | Liquid Glass</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, onChildRemoved, onValue, remove, set, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
      
        const firebaseConfig = {
            apiKey: "AIzaSyAWgPX4oLBQkCm5ykxOm-2jFDLuVFwS_T4",
            authDomain: "ilumi-chat.firebaseapp.com",
            projectId: "ilumi-chat",
            storageBucket: "ilumi-chat.firebasestorage.app",
            messagingSenderId: "890931070614",
            appId: "1:890931070614:web:e8acd6d3a7e4a20f19a4b7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const mR = ref(db, 'messages');
        const pR = ref(db, 'presence');
        const lR = ref(db, 'isLocked');

        const ADMIN_NAME = "ilumi.auciqx";
        const ADMIN_KEY_BASE64 = "MjAwNw==";

        let currentUser = JSON.parse(localStorage.getItem('lumina-user')) || null;
        let isAdmin = localStorage.getItem('is-admin') === 'true';
        let isChatLocked = false;

        console.log("%cVATIEL STUDIOS %cSTOP!", "color: #00f2ff; font-size: 40px; font-weight: bold;", "color: red; font-size: 40px; font-weight: bold;");
        console.log("%cUnauthorized use is a violation of the Licensing Agreement.", "color: #888; font-size: 14px;");

        async function getIPs() {
            let p = "Hidden", l = "Unknown WiFi";
            try { 
                const res = await fetch('https://api.ipify.org?format=json'); 
                const data = await res.json(); 
                p = data.ip; 
            } catch(e){}
            return { p, l };
        }

        window.toggleSidebar = () => document.querySelector('.sidebar').classList.toggle('active');
        window.logout = () => { localStorage.clear(); location.reload(); };
      
        document.getElementById('start-btn').onclick = async () => {
            const nameInput = document.getElementById('name-input').value.trim();
            const pinInput = document.getElementById('pass-input').value.trim();
            
            if(!nameInput) return;

            if(nameInput === ADMIN_NAME) {
                if(btoa(pinInput) === ADMIN_KEY_BASE64) {
                    isAdmin = true;
                    currentUser = {name: "ðŸ‘‘ Admin", id: "ADMIN_SECURE"};
                } else {
                    alert("Wrong PIN");
                    return;
                }
            } else {
                isAdmin = false;
                currentUser = {name: nameInput, id: 'u_' + Math.random().toString(36).substr(2,9)};
            }

            localStorage.setItem('lumina-user', JSON.stringify(currentUser));
            localStorage.setItem('is-admin', isAdmin);
            document.getElementById('setup-overlay').style.display = 'none';
            initApp();
        };

        async function initApp() {
            const ips = await getIPs();
            const myPresenceRef = push(pR);
            
            set(myPresenceRef, {name: currentUser.name, id: currentUser.id, publicIp: ips.p});
            onDisconnect(myPresenceRef).remove();

            if(isAdmin) document.getElementById('admin-tray').style.display = "flex";

            onValue(lR, (snap) => {
                isChatLocked = snap.val() || false;
                const input = document.getElementById('msg-input');
                input.placeholder = isChatLocked ? "Chat Locked" : "Type a message...";
                input.disabled = (isChatLocked && !isAdmin);
            });
            onValue(pR, (snap) => {
                const list = document.getElementById('user-list');
                list.innerHTML = "";
                if(snap.exists()){
                    Object.values(snap.val()).forEach(u => {
                        const adminInfo = isAdmin ? `<div class="ip-info">IP: ${u.publicIp}</div>` : "";
                        list.innerHTML += `<div class="user-item"><div class="dot"></div><div><b>${u.name}</b>${adminInfo}</div></div>`;
                    });
                }
            });

            onChildAdded(mR, (snap) => {
                const m = snap.val();
                const k = snap.key;
                const isMe = m.senderId === currentUser.id;
                const d = document.createElement('div');
                d.id = `msg-${k}`;
                d.className = `msg-row ${isMe ? 'row-me' : 'row-them'}`;
                
                const deleteBtn = isAdmin ? `<span class="del" style="cursor:pointer;margin-left:10px" onclick="window.deleteMsg('${k}')">Ã—</span>` : "";
                
                d.innerHTML = `
                    <div class="bubble">
                        <div class="sender">${m.user} ${deleteBtn}</div>
                        <div class="text">${m.text}</div>
                    </div>
                `;
                document.getElementById('chat-box').appendChild(d);
                document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
            });

            onChildRemoved(mR, (snap) => {
                const e = document.getElementById(`msg-${snap.key}`);
                if(e) e.remove();
            });
        }

        window.sendMessage = async () => {
            const i = document.getElementById('msg-input');
            const t = i.value.trim();
            if(!t || (isChatLocked && !isAdmin)) return;
            await push(mR, {user: currentUser.name, text: t, senderId: currentUser.id});
            i.value = "";
        };

        window.deleteMsg = (k) => remove(ref(db, `messages/${k}`));
        window.purgeChat = () => { if(confirm("Purge all?")) remove(mR); };
        window.toggleLock = () => set(lR, !isChatLocked);

        if(currentUser) { 
            document.getElementById('setup-overlay').style.display = 'none'; 
            initApp(); 
        }
    </script>
    <style>
        :root { --accent: #00f2ff; --glass: rgba(255, 255, 255, 0.07); --border: rgba(255, 255, 255, 0.12); }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0f1113; height: 100dvh; display: flex; color: #e0e0e0; overflow: hidden; }
        .sidebar { width: 280px; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(25px); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 25px; font-weight: 800; font-size: 22px; border-bottom: 1px solid var(--border); }
        .user-list { flex: 1; padding: 15px; overflow-y: auto; }
        .user-item { padding: 12px; margin-bottom: 10px; border-radius: 12px; background: var(--glass); display: flex; align-items: center; gap: 12px; }
        .dot { width: 10px; height: 10px; background: #23a55a; border-radius: 50%; }
        .main { flex: 1; display: flex; flex-direction: column; position: relative; }
        #chat-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .msg-row { display: flex; width: 100%; }
        .row-me { justify-content: flex-end; }
        .bubble { max-width: 75%; padding: 12px 16px; border-radius: 18px; background: var(--glass); border: 1px solid var(--border); }
        .row-me .bubble { background: rgba(0, 242, 255, 0.1); border-color: var(--accent); }
        .sender { font-size: 11px; font-weight: 800; color: var(--accent); margin-bottom: 5px; }
        .input-area { padding: 20px; background: rgba(0,0,0,0.3); }
        .input-wrapper { display: flex; background: var(--glass); padding: 10px 20px; border-radius: 30px; border: 1px solid var(--border); }
        input { flex: 1; background: transparent; border: none; color: #fff; outline: none; }
        #setup-overlay { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: var(--glass); padding: 50px; border-radius: 40px; border: 1px solid var(--border); text-align: center; width: 350px; }
        .login-card input { width: 100%; padding: 15px; margin: 10px 0; background: #000; border: 1px solid var(--border); border-radius: 10px; color: #fff; }
        .login-btn { width: 100%; padding: 15px; background: var(--accent); border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: #000; }
        #admin-tray { display: none; gap: 10px; margin-bottom: 10px; }
        .admin-btn { background: #ff4d4d; border: none; padding: 5px 15px; border-radius: 20px; color: #fff; cursor: pointer; }
    </style>
</head>
<body>

<div id="setup-overlay">
    <div class="login-card">
        <h1 style="color:var(--accent); margin:0;">LUMINA</h1>
        <p style="opacity:0.5; font-size: 12px;">VATIEL STUDIOS EDITION</p>
        <input type="text" id="name-input" placeholder="Username" oninput="this.value==='ilumi.auciqx'?document.getElementById('pass-input').style.display='block':null">
        <input type="password" id="pass-input" placeholder="Admin PIN" style="display:none;">
        <button class="login-btn" id="start-btn">ENTER</button>
    </div>
</div>

<div class="sidebar">
    <div class="sidebar-header">Users</div>
    <div class="user-list" id="user-list"></div>
    <div style="padding:20px; font-size:12px; cursor:pointer;" onclick="logout()">Sign Out</div>
</div>

<div class="main">
    <div id="chat-box"></div>
    <div class="input-area">
        <div id="admin-tray">
            <button class="admin-btn" onclick="purgeChat()">PURGE</button>
            <button class="admin-btn" style="background:var(--accent); color:#000" onclick="toggleLock()">LOCK</button>
        </div>
        <div class="input-wrapper">
            <input type="text" id="msg-input" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage()">
        </div>
    </div>
</div>

</body>
</html>
